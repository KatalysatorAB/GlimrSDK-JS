!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Glimr=t()}(function(){return function n(a,i,s){function o(e,t){if(!i[e]){if(!a[e]){var r="function"==typeof require&&require;if(!t&&r)return r(e,!0);if(c)return c(e,!0);throw(r=new Error("Cannot find module '"+e+"'")).code="MODULE_NOT_FOUND",r}r=i[e]={exports:{}},a[e][0].call(r.exports,function(t){return o(a[e][1][t]||t)},r,r.exports,n,a,i,s)}return i[e].exports}for(var c="function"==typeof require&&require,t=0;t<s.length;t++)o(s[t]);return o}({1:[function(t,e,r){"use strict";e.exports={GLIMR_HOST:"//pixel.glimr.io",GLIMR_PATHS:{tags:"/v4/iptags/:id/",store:"/v4/collect/:id/"},MAX_CACHE_TIME:300,CACHE_TIMINGS:{tags:0},V2_PREFIX:"[v2]:"}},{}],2:[function(t,e,r){"use strict";function n(){this.data={},this.hasData=!1}n.prototype={storePosition:function(t){if("number"!=typeof t.longitude&&isNaN(parseFloat(t.longitude))||"number"!=typeof t.latitude&&isNaN(parseFloat(t.latitude)))throw new Error("Glimr.storePosition requires one argument, an object with a numeric .longitude and .latitude");this._store("u_pos",[t.latitude,t.longitude].join(","))},storeUid:function(t){if(!t||"string"!=typeof t)throw new Error("Glimr.storeUid requires one string argument");this._store("uid",t)},_store:function(t,e){this.hasData=!0,this.data[t]=e},_flush:function(){var t=this.data;return this.data={},this.hasData=!1,t},_needsToFlush:function(){return this.hasData}},e.exports=n},{}],3:[function(t,e,r){"use strict";var n=t("./lib/functools"),a=t("./constants"),i=t("./serialize"),s=t("./tags"),o=t("./tag_cache"),c=t("./storage"),u=t("./enrichment"),h=function(){this.constructor=h,this.initialize()};function g(t,e){h.prototype[t]=function(){return this[e][t].apply(this[e],arguments)}}h.prototype={initialize:function(){this.url={host:a.GLIMR_HOST,tags:a.GLIMR_PATHS.tags,store:a.GLIMR_PATHS.store},this.storage=new c(n.bindFunction(this,function(){return this.useLocalStorage})),this.enrichment=new u,this.tagCache=new o(this.storage),this.tags=new s(this.storage,this.tagCache,this.url,this.enrichment),this.useLocalStorage=c.isSupportedByBrowser()}};for(var l=["objectToQuery","arrayToQuery","queryToObject","escapeStringForQuery","unescapeStringForQuery"],d=0;d<l.length;d+=1){var f=l[d];h.prototype[f]=i[f]}var p=["getPixelLastUpdated","getCachedURLTags","getCachedBehaviorTags","getCachedBehaviorTagsAndUpdateInBackground","getTagsAndPushToDataLayer","getTags"];for(d=0;d<p.length;d+=1)g(p[d],"tags");var T=["usesTagCache","isTagCacheValid","setTagCacheTimeInSeconds","getTagCacheTimeInSeconds","currentURLIdentifier"];for(d=0;d<T.length;d+=1)g(T[d],"tagCache");var C=["storePosition","storeUid"];for(d=0;d<C.length;d+=1)g(C[d],"enrichment");e.exports=new h},{"./constants":1,"./enrichment":2,"./lib/functools":4,"./serialize":9,"./storage":10,"./tag_cache":11,"./tags":12}],4:[function(t,e,r){"use strict";var n={bindFunction:function(t,e){function r(){}function n(){return i.apply(this instanceof r?this:t,a.concat(Array.prototype.slice.call(arguments)))}var a=Array.prototype.slice.call(arguments,2),i=e;return e.prototype&&(r.prototype=e.prototype),n.prototype=new r,n}};e.exports=n},{}],5:[function(t,e,r){"use strict";e.exports=function(t,e){var r=(new Date).getTime(),n="glmrjsonp"+Math.round(r+1000001*Math.random()),a=window.document.createElement("script");window[n]=function(t){e(t);try{delete window[n]}catch(t){window[n]=void 0}try{a.parentNode.removeChild(a)}catch(t){}},t+=-1===t.indexOf("?")?"?":"&",t+="callback="+n,"function"==typeof a.addEventListener&&a.addEventListener("error",function(){e(!1)},!1),a.setAttribute("src",t),window.document.getElementsByTagName("head")[0].appendChild(a)}},{}],6:[function(t,e,r){"use strict";e.exports=function(t){function c(t,e){return t<<e|t>>>32-e}function u(t,e){var r=2147483648&t,n=2147483648&e,a=1073741824&t,i=1073741824&e,e=(1073741823&t)+(1073741823&e);return a&i?2147483648^e^r^n:a|i?1073741824&e?3221225472^e^r^n:1073741824^e^r^n:e^r^n}function e(t,e,r,n,a,i,s){var o;return t=u(t,u(u((o=e)&r|~o&n,a),s)),u(c(t,i),e)}function r(t,e,r,n,a,i,s){return t=u(t,u(u(e&(n=n)|r&~n,a),s)),u(c(t,i),e)}function n(t,e,r,n,a,i,s){return t=u(t,u(u(e^r^n,a),s)),u(c(t,i),e)}function a(t,e,r,n,a,i,s){return t=u(t,u(u(r^(e|~n),a),s)),u(c(t,i),e)}function i(t){for(var e="",r="",n=0;n<=3;n+=1)e+=(r="0"+(t>>>8*n&255).toString(16)).substr(r.length-2,2);return e}for(var s,o,h,g,l=function(t){for(var e,r=t.length,n=16*(1+((n=r+8)-n%64)/64),a=Array(n-1),i=0,s=0;s<r;)i=s%4*8,a[e=(s-s%4)/4]=a[e]|t.charCodeAt(s)<<i,s+=1;return i=s%4*8,a[e=(s-s%4)/4]=a[e]|128<<i,a[n-2]=r<<3,a[n-1]=r>>>29,a}(t=function(t){t=t.replace(/\r\n/g,"\n");for(var e="",r=0;r<t.length;r+=1){var n=t.charCodeAt(r);n<128?e+=String.fromCharCode(n):(127<n&&n<2048?e+=String.fromCharCode(n>>6|192):(e+=String.fromCharCode(n>>12|224),e+=String.fromCharCode(n>>6&63|128)),e+=String.fromCharCode(63&n|128))}return e}(t)),d=1732584193,f=4023233417,p=2562383102,T=271733878,C=0;C<l.length;C+=16)d=e(s=d,o=f,h=p,g=T,l[C+0],7,3614090360),T=e(T,d,f,p,l[C+1],12,3905402710),p=e(p,T,d,f,l[C+2],17,606105819),f=e(f,p,T,d,l[C+3],22,3250441966),d=e(d,f,p,T,l[C+4],7,4118548399),T=e(T,d,f,p,l[C+5],12,1200080426),p=e(p,T,d,f,l[C+6],17,2821735955),f=e(f,p,T,d,l[C+7],22,4249261313),d=e(d,f,p,T,l[C+8],7,1770035416),T=e(T,d,f,p,l[C+9],12,2336552879),p=e(p,T,d,f,l[C+10],17,4294925233),f=e(f,p,T,d,l[C+11],22,2304563134),d=e(d,f,p,T,l[C+12],7,1804603682),T=e(T,d,f,p,l[C+13],12,4254626195),p=e(p,T,d,f,l[C+14],17,2792965006),d=r(d,f=e(f,p,T,d,l[C+15],22,1236535329),p,T,l[C+1],5,4129170786),T=r(T,d,f,p,l[C+6],9,3225465664),p=r(p,T,d,f,l[C+11],14,643717713),f=r(f,p,T,d,l[C+0],20,3921069994),d=r(d,f,p,T,l[C+5],5,3593408605),T=r(T,d,f,p,l[C+10],9,38016083),p=r(p,T,d,f,l[C+15],14,3634488961),f=r(f,p,T,d,l[C+4],20,3889429448),d=r(d,f,p,T,l[C+9],5,568446438),T=r(T,d,f,p,l[C+14],9,3275163606),p=r(p,T,d,f,l[C+3],14,4107603335),f=r(f,p,T,d,l[C+8],20,1163531501),d=r(d,f,p,T,l[C+13],5,2850285829),T=r(T,d,f,p,l[C+2],9,4243563512),p=r(p,T,d,f,l[C+7],14,1735328473),d=n(d,f=r(f,p,T,d,l[C+12],20,2368359562),p,T,l[C+5],4,4294588738),T=n(T,d,f,p,l[C+8],11,2272392833),p=n(p,T,d,f,l[C+11],16,1839030562),f=n(f,p,T,d,l[C+14],23,4259657740),d=n(d,f,p,T,l[C+1],4,2763975236),T=n(T,d,f,p,l[C+4],11,1272893353),p=n(p,T,d,f,l[C+7],16,4139469664),f=n(f,p,T,d,l[C+10],23,3200236656),d=n(d,f,p,T,l[C+13],4,681279174),T=n(T,d,f,p,l[C+0],11,3936430074),p=n(p,T,d,f,l[C+3],16,3572445317),f=n(f,p,T,d,l[C+6],23,76029189),d=n(d,f,p,T,l[C+9],4,3654602809),T=n(T,d,f,p,l[C+12],11,3873151461),p=n(p,T,d,f,l[C+15],16,530742520),d=a(d,f=n(f,p,T,d,l[C+2],23,3299628645),p,T,l[C+0],6,4096336452),T=a(T,d,f,p,l[C+7],10,1126891415),p=a(p,T,d,f,l[C+14],15,2878612391),f=a(f,p,T,d,l[C+5],21,4237533241),d=a(d,f,p,T,l[C+12],6,1700485571),T=a(T,d,f,p,l[C+3],10,2399980690),p=a(p,T,d,f,l[C+10],15,4293915773),f=a(f,p,T,d,l[C+1],21,2240044497),d=a(d,f,p,T,l[C+8],6,1873313359),T=a(T,d,f,p,l[C+15],10,4264355552),p=a(p,T,d,f,l[C+6],15,2734768916),f=a(f,p,T,d,l[C+13],21,1309151649),d=a(d,f,p,T,l[C+4],6,4149444226),T=a(T,d,f,p,l[C+11],10,3174756917),p=a(p,T,d,f,l[C+2],15,718787259),f=a(f,p,T,d,l[C+9],21,3951481745),d=u(d,s),f=u(f,o),p=u(p,h),T=u(T,g);return(i(d)+i(f)+i(p)+i(T)).toLowerCase()}},{}],7:[function(t,e,r){"use strict";var s={flattenObjectIntoArray:function(t){var e,r=[];for(e in t)if(Object.prototype.hasOwnProperty.call(t,e)){var n=t[e];if("object"==typeof n&&n.constructor===Array)for(var a=0,i=n.length;a<i;a+=1)r.push(n[a]);else"object"==typeof n?r=r.concat(s.flattenObjectIntoArray(n)):r.push(n)}return r}};e.exports=s},{}],8:[function(t,e,r){"use strict";var n=function(){var t,e,r=(new Date).getTime().toString();try{return(t=window.localStorage).setItem(r,r),e=t.getItem(r)===r,t.removeItem(r),e&&t}catch(t){}}();e.exports=n},{}],9:[function(t,e,r){"use strict";var c={objectToQuery:function(t,e){e=e||"";var r,n=[];for(r in t)if(Object.prototype.hasOwnProperty.call(t,r)){var a=t[r],i=e.length?e+"["+c.escapeStringForQuery(r)+"]":c.escapeStringForQuery(r);if("object"==typeof a&&a.constructor===Array){for(var s=0,o=a.length;s<o;s+=1)n.push(i+"="+c.escapeStringForQuery(a[s])),n.push("&");n.pop()}else"object"==typeof a?n.push(c.objectToQuery(a,i)):n.push(i+"="+c.escapeStringForQuery(a));n.push("&")}return n.pop(),n.join("")},arrayToQuery:function(t,e){e=e||"";for(var r=c.escapeStringForQuery(e),n=[],a=0,i=t.length;a<i;a+=1){var s=c.escapeStringForQuery(t[a]);n.push(r+"="+s)}return n.join("&")},queryToObject:function(t){for(var e={},r=t.split("&"),n=0,a=r.length;n<a;n+=1){var i=r[n].split("="),s=c.unescapeStringForQuery(i[0]||""),i=c.unescapeStringForQuery(i[1]||"");void 0===e[s]&&(e[s]=[]),0<i.length&&e[s].push(i)}return e},escapeStringForQuery:function(t){return encodeURIComponent(t)},unescapeStringForQuery:function(t){return decodeURIComponent(t)}};e.exports=c},{}],10:[function(t,e,r){"use strict";var n=t("./lib/storage");function a(t){this._isEnabledCallback=t}a.prototype={set:function(t,e){n[t]=e},get:function(t){return n[t]},isEnabled:function(){return this._isEnabledCallback()}},a.isSupportedByBrowser=function(){return!!n},e.exports=a},{"./lib/storage":8}],11:[function(t,e,r){"use strict";var n=t("./lib/md5"),a=t("./constants"),i=t("./serialize");function s(t){this.storage=t,this.state={urlCache:{},currentURLCacheKey:!1}}s.prototype={usesTagCache:function(){return 0<a.CACHE_TIMINGS.tags&&this.storage.isEnabled()},isTagCacheValid:function(t){if(void 0===t)throw new TypeError("Parameter #0 is required: pixelId");var e=parseInt(this.storage.get("glimrTags_"+t+"_lastUpdate"),10),t=(new Date).getTime();return!isNaN(e)&&(t-e)/1e3<a.CACHE_TIMINGS.tags},setTagCacheTimeInSeconds:function(t){t>a.MAX_CACHE_TIME&&(t=a.MAX_CACHE_TIME),a.CACHE_TIMINGS.tags=t},getTagCacheTimeInSeconds:function(){return a.CACHE_TIMINGS.tags},currentURLIdentifier:function(){return window.document.location.hash&&-1!==window.document.location.hash.indexOf("#!")?window.document.location.hash.replace("#!",""):window.document.location.pathname},_currentURLCacheKey:function(){return this.state.currentURLCacheKey||n(this.currentURLIdentifier()).substr(0,10)},_unmarshalTags:function(t){if(!t)return{};for(var e=t.split("|"),r={},n=0;n<e.length;n+=1){var a=e[n].indexOf("=");r[e[n].substring(0,a)]=this._deserializeTags(e[n].substring(a+1))}return r},_marshalTags:function(t){var e,r=[];for(e in t)t.hasOwnProperty(e)&&r.push(e.substr(0,10)+"="+this._serializeTags(t[e]));return r.join("|")},_getOrUnmarshalCache:function(t){return this.storage.isEnabled()&&this.storage.get("glimrArticleTags_"+t)&&(this.state.urlCache[t]=this._unmarshalTags(this.storage.get("glimrArticleTags_"+t))),this.state.urlCache[t]||{}},_serializeTags:function(t){return"object"==typeof t&&t.constructor===Array?t.join(","):a.V2_PREFIX+i.objectToQuery(t)},_deserializeTags:function(t){return(t=t||"").substr(0,a.V2_PREFIX.length)===a.V2_PREFIX?i.queryToObject(t.substr(a.V2_PREFIX.length)):""===t?[]:t.split(",")},_updateTagCache:function(t,e){this.storage.isEnabled()&&(this.storage.set("glimrTags_"+t+"_lastUpdate",(new Date).getTime()),this.storage.set("glimrTags_"+t,this._serializeTags(e)))},_updateURLCache:function(t,e){for(var r in this.storage.isEnabled()&&(this.storage.set("glimrArticleTags_"+t,this._marshalTags(e)),this.storage.set("glimrArticleTags_"+t+"_lastUpdate",(new Date).getTime())),this.state.urlCache[t]||(this.state.urlCache[t]={}),e)e.hasOwnProperty(r)&&(this.state.urlCache[t][r.substr(0,10)]=e[r])}},e.exports=s},{"./constants":1,"./lib/md5":6,"./serialize":9}],12:[function(t,e,r){"use strict";var n=t("./lib/functools"),a=t("./lib/objecttools"),s=(t("./lib/md5"),t("./lib/jsonp")),o=t("./serialize");t("./constants");function i(t,e){return new TypeError("Parameter #"+t+" is required: "+e)}function c(t,e,r,n){this.storage=t,this.tagCache=e,this.state={loadingTags:{},loadedTags:{},currentURLCacheKey:!1},this.networkRequests=0,this.url=r,this.enrichment=n}c.prototype={getPixelLastUpdated:function(t){return this.storage.isEnabled()&&this.storage.get("glimrArticleTags_"+t+"_lastUpdate")||!1},getCachedURLTags:function(t){if(void 0===t)throw i(0,"pixelId");var e=this.tagCache._getOrUnmarshalCache(t),t=this.tagCache._currentURLCacheKey();return e[t]||(e[t]=[]),e[t]},getCachedBehaviorTags:function(t){if(void 0===t)throw i(0,"pixelId");return!(!this.tagCache.usesTagCache()||!this.tagCache.isTagCacheValid(t))&&this._getLocalTags(t)[0]},getCachedBehaviorTagsAndUpdateInBackground:function(t,e){if(void 0===t)throw i(0,"pixelId");if((e=e||{}).onUpdate="function"==typeof e.onUpdate?e.onUpdate:function(){},!this.tagCache.usesTagCache())return window.console&&window.console.error("Caching not enabled. Enable with Glimr.setTagCacheTimeInSeconds(number)"),[];var r=this._getLocalTags(t);return this.tagCache.isTagCacheValid(t)||this.getTags(t,e.onUpdate),r[0]||!1},getTagsAndPushToDataLayer:function(t,e){if(void 0===t)throw i(0,"pixelId");this.getTags(t,function(t){window.dataLayer&&window.dataLayer.push&&window.dataLayer.push({glimrTags:t,event:"glimr.tags"}),e&&"function"==typeof e&&e()})},getTags:function(c,t){if(void 0===c)throw i(0,"pixelId");var u=c+this.tagCache._currentURLCacheKey();this._needsToMakeRequest()||!this.state.loadedTags[u]?void 0===this.state.loadingTags[u]?this._requestTags(c,u,t,n.bindFunction(this,function(t){var e=[],r={},n=e;t&&t.tags&&(n=e=t.tags),t&&t.mapping&&(n=r=t.mapping),t&&t.cache&&this.tagCache._updateURLCache(c,t.cache),this.tagCache.usesTagCache()&&this.tagCache._updateTagCache(c,n);for(var a=this.getCachedURLTags(c),i=0;i<a.length;i+=1)-1===e.indexOf(a[i])&&(e.push(a[i]),r.urlTags=r.urlTags||[],r.urlTags.push(a[i]));this.state.loadedTags[u]=[e,r];var s=this.state.loadingTags[u];delete this.state.loadingTags[u];for(var o=0;o<s.length;o+=1)s[o](e,r)})):this.state.loadingTags[u].push(t):t((t=this.state.loadedTags[u])[0],t[1])},_getLocalTags:function(t){var e=this.tagCache._deserializeTags(this.storage.get("glimrTags_"+t)),t=this.getCachedURLTags(t);return"object"==typeof e&&e.constructor===Array?[e.concat(t),{urlTags:t}]:(e.urlTags=t,[a.flattenObjectIntoArray(e),e])},_requestTags:function(t,e,r,n){var a,i=this.getPixelLastUpdated(t);!this._needsToMakeRequest()&&this.tagCache.usesTagCache()&&this.tagCache.isTagCacheValid(t)?r((a=this._getLocalTags(t))[0],a[1]):(a="",i&&(a+="&keywords_last_updated="+i),window.document.location.hash&&(a+="&fragment="+encodeURIComponent(window.document.location.hash)),a+="&"+o.objectToQuery(this.enrichment._flush()),a=(this.url.host+this.url.tags).replace(":id",t)+"?id=0"+a,this.state.loadingTags[e]=[],this.state.loadingTags[e].push(r),this.networkRequests+=1,s(a,n))},_needsToMakeRequest:function(){return this.enrichment._needsToFlush()}},e.exports=c},{"./constants":1,"./lib/functools":4,"./lib/jsonp":5,"./lib/md5":6,"./lib/objecttools":7,"./serialize":9}]},{},[3])(3)});
