!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Glimr=t()}}(function(){return function a(o,s,c){function u(e,t){if(!s[e]){if(!o[e]){var r="function"==typeof require&&require;if(!t&&r)return r(e,!0);if(h)return h(e,!0);var i=new Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}var n=s[e]={exports:{}};o[e][0].call(n.exports,function(t){return u(o[e][1][t]||t)},n,n.exports,a,o,s,c)}return s[e].exports}for(var h="function"==typeof require&&require,t=0;t<c.length;t++)u(c[t]);return u}({1:[function(t,e,r){"use strict";e.exports={GLIMR_HOST:"//pixel.glimr.io",GLIMR_PATHS:{tags:"/v4/iptags/:id/",store:"/v4/collect/:id/"},MAX_CACHE_TIME:300,CACHE_TIMINGS:{tags:0},V2_PREFIX:"[v2]:"}},{}],2:[function(t,e,r){"use strict";function i(){this.data={},this.hasData=!1}i.prototype={storePosition:function(t){if("number"!=typeof t.longitude&&isNaN(parseFloat(t.longitude))||"number"!=typeof t.latitude&&isNaN(parseFloat(t.latitude)))throw new Error("Glimr.storePosition requires one argument, an object with a numeric .longitude and .latitude");this._store("u_pos",[t.latitude,t.longitude].join(","))},storeUid:function(t){if(!t||"string"!=typeof t)throw new Error("Glimr.storeUid requires one string argument");this._store("uid",t)},_store:function(t,e){this.hasData=!0,this.data[t]=e},_flush:function(){var t=this.data;return this.data={},this.hasData=!1,t},_needsToFlush:function(){return this.hasData}},e.exports=i},{}],3:[function(t,e,r){"use strict";var i=t("./lib/functools"),n=t("./constants"),a=t("./serialize"),o=t("./tags"),s=t("./glimr_id"),c=t("./tag_cache"),u=t("./storage"),h=t("./enrichment"),g=function(){this.constructor=g,this.initialize()};function l(t,e){g.prototype[t]=function(){return this[e][t].apply(this[e],arguments)}}g.prototype={initialize:function(){if(this.url={host:n.GLIMR_HOST,tags:n.GLIMR_PATHS.tags,store:n.GLIMR_PATHS.store},this.glimrId=new s,this.storage=new u(i.bindFunction(this,function(){return this.useLocalStorage})),this.enrichment=new h,this.tagCache=new c(this.storage),this.tags=new o(this.storage,this.tagCache,this.glimrId,this.url,this.enrichment),this.useLocalStorage=u.isSupportedByBrowser(),window.Glimr.cmd){var t=window.Glimr.cmd;window.Glimr=this,t.forEach(function(t){t()})}}};var d,f=["objectToQuery","arrayToQuery","queryToObject","escapeStringForQuery","unescapeStringForQuery"];for(d=0;d<f.length;d+=1){var p=f[d];g.prototype[p]=a[p]}var T=["getPixelLastUpdated","getCachedURLTags","getCachedBehaviorTags","getCachedBehaviorTagsAndUpdateInBackground","getTagsAndPushToDataLayer","getTags"];for(d=0;d<T.length;d+=1)l(T[d],"tags");var m=["usesTagCache","isTagCacheValid","setTagCacheTimeInSeconds","getTagCacheTimeInSeconds","currentURLIdentifier"];for(d=0;d<m.length;d+=1)l(m[d],"tagCache");var C=["storePosition","storeUid"];for(d=0;d<C.length;d+=1)l(C[d],"enrichment");e.exports=new g},{"./constants":1,"./enrichment":2,"./glimr_id":4,"./lib/functools":6,"./serialize":12,"./storage":13,"./tag_cache":14,"./tags":15}],4:[function(t,e,r){"use strict";var i=t("./lib/cookies"),n=t("./lib/uuid");function a(){this.initialize()}a.prototype={initialize:function(){this._id=i.readCookie("__glmrid"),this._id||this.setId(n.generate())},setGlimrCookie:function(){i.createCookie("__glmrid",this._id)},getId:function(){return this._id},setId:function(t){this._id=t,this.setGlimrCookie()}},e.exports=a},{"./lib/cookies":5,"./lib/uuid":11}],5:[function(t,e,r){"use strict";var i={createCookie:function(t,e,r){var i=window.document.location.hostname.split("."),n=i.slice(i.length-2,i.length).join("."),a="";if(r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3),a="; expires="+o.toGMTString()}window.document.cookie=t+"="+e+a+"; path=/; domain="+n},readCookie:function(t){for(var e=t+"=",r=window.document.cookie.split(";"),i=0;i<r.length;i+=1){for(var n=r[i];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(e))return n.substring(e.length,n.length)}return null}};e.exports=i},{}],6:[function(t,e,r){"use strict";var i={bindFunction:function(t,e){function r(){}function i(){return a.apply(this instanceof r?this:t,n.concat(Array.prototype.slice.call(arguments)))}var n=Array.prototype.slice.call(arguments,2),a=e;return e.prototype&&(r.prototype=e.prototype),i.prototype=new r,i}};e.exports=i},{}],7:[function(t,e,r){"use strict";e.exports=function(t,e){var r=(new Date).getTime(),i="glmrjsonp"+Math.round(r+1000001*Math.random()),n=window.document.createElement("script");window[i]=function(t){e(t);try{delete window[i]}catch(t){window[i]=void 0}try{n.parentNode.removeChild(n)}catch(t){}},t+=-1===t.indexOf("?")?"?":"&",t+="callback="+i,"function"==typeof n.addEventListener&&n.addEventListener("error",function(){e(!1)},!1),n.setAttribute("src",t),window.document.getElementsByTagName("head")[0].appendChild(n)}},{}],8:[function(t,e,r){"use strict";e.exports=function(t){function c(t,e){return t<<e|t>>>32-e}function u(t,e){var r,i,n,a,o;return n=2147483648&t,a=2147483648&e,o=(1073741823&t)+(1073741823&e),(r=1073741824&t)&(i=1073741824&e)?2147483648^o^n^a:r|i?1073741824&o?3221225472^o^n^a:1073741824^o^n^a:o^n^a}function e(t,e,r,i,n,a,o){var s;return t=u(t,u(u((s=e)&r|~s&i,n),o)),u(c(t,a),e)}function r(t,e,r,i,n,a,o){var s;return t=u(t,u(u(e&(s=i)|r&~s,n),o)),u(c(t,a),e)}function i(t,e,r,i,n,a,o){return t=u(t,u(u(e^r^i,n),o)),u(c(t,a),e)}function n(t,e,r,i,n,a,o){return t=u(t,u(u(r^(e|~i),n),o)),u(c(t,a),e)}function a(t){var e,r="",i="";for(e=0;e<=3;e+=1)r+=(i="0"+(t>>>8*e&255).toString(16)).substr(i.length-2,2);return r}var o,s,h,g,l,d,f,p,T,m;for(o=function(t){for(var e,r=t.length,i=r+8,n=16*(1+(i-i%64)/64),a=Array(n-1),o=0,s=0;s<r;)o=s%4*8,a[e=(s-s%4)/4]=a[e]|t.charCodeAt(s)<<o,s+=1;return o=s%4*8,a[e=(s-s%4)/4]=a[e]|128<<o,a[n-2]=r<<3,a[n-1]=r>>>29,a}(t=function(t){t=t.replace(/\r\n/g,"\n");for(var e="",r=0;r<t.length;r+=1){var i=t.charCodeAt(r);i<128?e+=String.fromCharCode(i):(127<i&&i<2048?e+=String.fromCharCode(i>>6|192):(e+=String.fromCharCode(i>>12|224),e+=String.fromCharCode(i>>6&63|128)),e+=String.fromCharCode(63&i|128))}return e}(t)),f=1732584193,p=4023233417,T=2562383102,m=271733878,s=0;s<o.length;s+=16)f=e(h=f,g=p,l=T,d=m,o[s+0],7,3614090360),m=e(m,f,p,T,o[s+1],12,3905402710),T=e(T,m,f,p,o[s+2],17,606105819),p=e(p,T,m,f,o[s+3],22,3250441966),f=e(f,p,T,m,o[s+4],7,4118548399),m=e(m,f,p,T,o[s+5],12,1200080426),T=e(T,m,f,p,o[s+6],17,2821735955),p=e(p,T,m,f,o[s+7],22,4249261313),f=e(f,p,T,m,o[s+8],7,1770035416),m=e(m,f,p,T,o[s+9],12,2336552879),T=e(T,m,f,p,o[s+10],17,4294925233),p=e(p,T,m,f,o[s+11],22,2304563134),f=e(f,p,T,m,o[s+12],7,1804603682),m=e(m,f,p,T,o[s+13],12,4254626195),T=e(T,m,f,p,o[s+14],17,2792965006),f=r(f,p=e(p,T,m,f,o[s+15],22,1236535329),T,m,o[s+1],5,4129170786),m=r(m,f,p,T,o[s+6],9,3225465664),T=r(T,m,f,p,o[s+11],14,643717713),p=r(p,T,m,f,o[s+0],20,3921069994),f=r(f,p,T,m,o[s+5],5,3593408605),m=r(m,f,p,T,o[s+10],9,38016083),T=r(T,m,f,p,o[s+15],14,3634488961),p=r(p,T,m,f,o[s+4],20,3889429448),f=r(f,p,T,m,o[s+9],5,568446438),m=r(m,f,p,T,o[s+14],9,3275163606),T=r(T,m,f,p,o[s+3],14,4107603335),p=r(p,T,m,f,o[s+8],20,1163531501),f=r(f,p,T,m,o[s+13],5,2850285829),m=r(m,f,p,T,o[s+2],9,4243563512),T=r(T,m,f,p,o[s+7],14,1735328473),f=i(f,p=r(p,T,m,f,o[s+12],20,2368359562),T,m,o[s+5],4,4294588738),m=i(m,f,p,T,o[s+8],11,2272392833),T=i(T,m,f,p,o[s+11],16,1839030562),p=i(p,T,m,f,o[s+14],23,4259657740),f=i(f,p,T,m,o[s+1],4,2763975236),m=i(m,f,p,T,o[s+4],11,1272893353),T=i(T,m,f,p,o[s+7],16,4139469664),p=i(p,T,m,f,o[s+10],23,3200236656),f=i(f,p,T,m,o[s+13],4,681279174),m=i(m,f,p,T,o[s+0],11,3936430074),T=i(T,m,f,p,o[s+3],16,3572445317),p=i(p,T,m,f,o[s+6],23,76029189),f=i(f,p,T,m,o[s+9],4,3654602809),m=i(m,f,p,T,o[s+12],11,3873151461),T=i(T,m,f,p,o[s+15],16,530742520),f=n(f,p=i(p,T,m,f,o[s+2],23,3299628645),T,m,o[s+0],6,4096336452),m=n(m,f,p,T,o[s+7],10,1126891415),T=n(T,m,f,p,o[s+14],15,2878612391),p=n(p,T,m,f,o[s+5],21,4237533241),f=n(f,p,T,m,o[s+12],6,1700485571),m=n(m,f,p,T,o[s+3],10,2399980690),T=n(T,m,f,p,o[s+10],15,4293915773),p=n(p,T,m,f,o[s+1],21,2240044497),f=n(f,p,T,m,o[s+8],6,1873313359),m=n(m,f,p,T,o[s+15],10,4264355552),T=n(T,m,f,p,o[s+6],15,2734768916),p=n(p,T,m,f,o[s+13],21,1309151649),f=n(f,p,T,m,o[s+4],6,4149444226),m=n(m,f,p,T,o[s+11],10,3174756917),T=n(T,m,f,p,o[s+2],15,718787259),p=n(p,T,m,f,o[s+9],21,3951481745),f=u(f,h),p=u(p,g),T=u(T,l),m=u(m,d);return(a(f)+a(p)+a(T)+a(m)).toLowerCase()}},{}],9:[function(t,e,r){"use strict";var o={flattenObjectIntoArray:function(t){var e=[];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){var i=t[r];if("object"==typeof i&&i.constructor===Array)for(var n=0,a=i.length;n<a;n+=1)e.push(i[n]);else"object"==typeof i?e=e.concat(o.flattenObjectIntoArray(i)):e.push(i)}return e}};e.exports=o},{}],10:[function(t,e,r){"use strict";var i=function(){var t,e,r=(new Date).getTime().toString();try{return(t=window.localStorage).setItem(r,r),e=t.getItem(r)===r,t.removeItem(r),e&&t}catch(t){}}();e.exports=i},{}],11:[function(t,e,r){"use strict";var i={generate:function(){var r=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===t?e:3&e|8).toString(16)})}};e.exports=i},{}],12:[function(t,e,r){"use strict";var c={objectToQuery:function(t,e){e=e||"";var r=[];for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i)){var n,a=t[i];if(n=e.length?e+"["+c.escapeStringForQuery(i)+"]":c.escapeStringForQuery(i),"object"==typeof a&&a.constructor===Array){for(var o=0,s=a.length;o<s;o+=1)r.push(n+"="+c.escapeStringForQuery(a[o])),r.push("&");r.pop()}else"object"==typeof a?r.push(c.objectToQuery(a,n)):r.push(n+"="+c.escapeStringForQuery(a));r.push("&")}return r.pop(),r.join("")},arrayToQuery:function(t,e){e=e||"";for(var r=c.escapeStringForQuery(e),i=[],n=0,a=t.length;n<a;n+=1){var o=c.escapeStringForQuery(t[n]);i.push(r+"="+o)}return i.join("&")},queryToObject:function(t){for(var e={},r=t.split("&"),i=0,n=r.length;i<n;i+=1){var a=r[i].split("="),o=c.unescapeStringForQuery(a[0]||""),s=c.unescapeStringForQuery(a[1]||"");void 0===e[o]&&(e[o]=[]),0<s.length&&e[o].push(s)}return e},escapeStringForQuery:function(t){return encodeURIComponent(t)},unescapeStringForQuery:function(t){return decodeURIComponent(t)}};e.exports=c},{}],13:[function(t,e,r){"use strict";var i=t("./lib/storage");function n(t){this._isEnabledCallback=t}n.prototype={set:function(t,e){i[t]=e},get:function(t){return i[t]},isEnabled:function(){return this._isEnabledCallback()}},n.isSupportedByBrowser=function(){return!!i},e.exports=n},{"./lib/storage":10}],14:[function(t,e,r){"use strict";var i=t("./lib/md5"),n=t("./constants"),a=t("./serialize");function o(t){this.storage=t,this.state={urlCache:{},currentURLCacheKey:!1}}o.prototype={usesTagCache:function(){return 0<n.CACHE_TIMINGS.tags&&this.storage.isEnabled()},isTagCacheValid:function(t){if(void 0===t)throw new TypeError("Parameter #"+0+" is required: "+"pixelId");var e=parseInt(this.storage.get("glimrTags_"+t+"_lastUpdate"),10),r=(new Date).getTime();return!isNaN(e)&&(r-e)/1e3<n.CACHE_TIMINGS.tags},setTagCacheTimeInSeconds:function(t){t>n.MAX_CACHE_TIME&&(t=n.MAX_CACHE_TIME),n.CACHE_TIMINGS.tags=t},getTagCacheTimeInSeconds:function(){return n.CACHE_TIMINGS.tags},currentURLIdentifier:function(){return window.document.location.hash&&-1!==window.document.location.hash.indexOf("#!")?window.document.location.hash.replace("#!",""):window.document.location.pathname},_currentURLCacheKey:function(){return this.state.currentURLCacheKey?this.state.currentURLCacheKey:i(this.currentURLIdentifier()).substr(0,10)},_unmarshalTags:function(t){if(!t)return{};for(var e=t.split("|"),r={},i=0;i<e.length;i+=1){var n=e[i].indexOf("=");r[e[i].substring(0,n)]=this._deserializeTags(e[i].substring(n+1))}return r},_marshalTags:function(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&e.push(r.substr(0,10)+"="+this._serializeTags(t[r]));return e.join("|")},_getOrUnmarshalCache:function(t){return this.storage.isEnabled()&&this.storage.get("glimrArticleTags_"+t)&&(this.state.urlCache[t]=this._unmarshalTags(this.storage.get("glimrArticleTags_"+t))),this.state.urlCache[t]||{}},_serializeTags:function(t){return"object"==typeof t&&t.constructor===Array?t.join(","):n.V2_PREFIX+a.objectToQuery(t)},_deserializeTags:function(t){return(t=t||"").substr(0,n.V2_PREFIX.length)===n.V2_PREFIX?a.queryToObject(t.substr(n.V2_PREFIX.length)):""===t?[]:t.split(",")},_updateTagCache:function(t,e){this.storage.isEnabled()&&(this.storage.set("glimrTags_"+t+"_lastUpdate",(new Date).getTime()),this.storage.set("glimrTags_"+t,this._serializeTags(e)))},_updateURLCache:function(t,e){for(var r in this.storage.isEnabled()&&(this.storage.set("glimrArticleTags_"+t,this._marshalTags(e)),this.storage.set("glimrArticleTags_"+t+"_lastUpdate",(new Date).getTime())),this.state.urlCache[t]||(this.state.urlCache[t]={}),e)e.hasOwnProperty(r)&&(this.state.urlCache[t][r.substr(0,10)]=e[r])}},e.exports=o},{"./constants":1,"./lib/md5":8,"./serialize":12}],15:[function(t,e,r){"use strict";var i=t("./lib/functools"),n=t("./lib/objecttools"),c=(t("./lib/md5"),t("./lib/jsonp")),u=t("./serialize");t("./constants");function a(t,e){return new TypeError("Parameter #"+t+" is required: "+e)}function o(t,e,r,i,n){this.storage=t,this.tagCache=e,this.state={loadingTags:{},loadedTags:{},currentURLCacheKey:!1},this.networkRequests=0,this.glimrId=r,this.url=i,this.enrichment=n}o.prototype={getPixelLastUpdated:function(t){return this.storage.isEnabled()&&this.storage.get("glimrArticleTags_"+t+"_lastUpdate")||!1},getCachedURLTags:function(t){if(void 0===t)throw a(0,"pixelId");var e=this.tagCache._getOrUnmarshalCache(t),r=this.tagCache._currentURLCacheKey();return e[r]||(e[r]=[]),e[r]},getCachedBehaviorTags:function(t){if(void 0===t)throw a(0,"pixelId");return!(!this.tagCache.usesTagCache()||!this.tagCache.isTagCacheValid(t))&&this._getLocalTags(t)[0]},getCachedBehaviorTagsAndUpdateInBackground:function(t,e){if(void 0===t)throw a(0,"pixelId");if((e=e||{}).onUpdate="function"==typeof e.onUpdate?e.onUpdate:function(){},!this.tagCache.usesTagCache())return window.console&&window.console.error("Caching not enabled. Enable with Glimr.setTagCacheTimeInSeconds(number)"),[];var r=this._getLocalTags(t);return this.tagCache.isTagCacheValid(t)||this.getTags(t,e.onUpdate),r[0]||!1},getTagsAndPushToDataLayer:function(t,e){if(void 0===t)throw a(0,"pixelId");this.getTags(t,function(t){window.dataLayer&&window.dataLayer.push&&window.dataLayer.push({glimrTags:t,event:"glimr.tags"}),e&&"function"==typeof e&&e()})},getTags:function(c,t){if(void 0===c)throw a(0,"pixelId");var u=c+this.tagCache._currentURLCacheKey();if(this._needsToMakeRequest()||!this.state.loadedTags[u])void 0===this.state.loadingTags[u]?this._requestTags(c,u,t,i.bindFunction(this,function(t){var e=[],r={},i=e;t&&t.tags&&(i=e=t.tags),t&&t.mapping&&(i=r=t.mapping),t&&t.cache&&this.tagCache._updateURLCache(c,t.cache),this.tagCache.usesTagCache()&&this.tagCache._updateTagCache(c,i);for(var n=this.getCachedURLTags(c),a=0;a<n.length;a+=1)-1===e.indexOf(n[a])&&(e.push(n[a]),r.urlTags=r.urlTags||[],r.urlTags.push(n[a]));this.state.loadedTags[u]=[e,r];var o=this.state.loadingTags[u];delete this.state.loadingTags[u];for(var s=0;s<o.length;s+=1)o[s](e,r);"string"==typeof t.id&&t.id!==this.glimrId.getId()&&this.glimrId.setId(t.id)})):this.state.loadingTags[u].push(t);else{var e=this.state.loadedTags[u];t(e[0],e[1])}},_getLocalTags:function(t){var e=this.tagCache._deserializeTags(this.storage.get("glimrTags_"+t)),r=this.getCachedURLTags(t);return"object"==typeof e&&e.constructor===Array?[e.concat(r),{urlTags:r}]:(e.urlTags=r,[n.flattenObjectIntoArray(e),e])},_requestTags:function(t,e,r,i){var n=this.getPixelLastUpdated(t);if(!this._needsToMakeRequest()&&this.tagCache.usesTagCache()&&this.tagCache.isTagCacheValid(t)){var a=this._getLocalTags(t);r(a[0],a[1])}else{var o="";n&&(o+="&keywords_last_updated="+n),window.document.location.hash&&(o+="&fragment="+encodeURIComponent(window.document.location.hash)),o+="&"+u.objectToQuery(this.enrichment._flush());var s=(this.url.host+this.url.tags).replace(":id",t)+"?id="+this.glimrId.getId()+o;this.state.loadingTags[e]=[],this.state.loadingTags[e].push(r),this.networkRequests+=1,c(s,i)}},_needsToMakeRequest:function(){return this.enrichment._needsToFlush()}},e.exports=o},{"./constants":1,"./lib/functools":6,"./lib/jsonp":7,"./lib/md5":8,"./lib/objecttools":9,"./serialize":12}]},{},[3])(3)});
