!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.Glimr=t()}}(function(){return function t(e,r,n){function i(o,s){if(!r[o]){if(!e[o]){var u="function"==typeof require&&require;if(!s&&u)return u(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var h=r[o]={exports:{}};e[o][0].call(h.exports,function(t){var r=e[o][1][t];return i(r?r:t)},h,h.exports,t,e,r,n)}return r[o].exports}for(var a="function"==typeof require&&require,o=0;o<n.length;o++)i(n[o]);return i}({1:[function(t,e,r){"use strict";e.exports={GLIMR_HOST:"//pixel.glimr.io",GLIMR_PATHS:{tags:"/v4/iptags/:id/",store:"/v4/collect/:id/"},MAX_CACHE_TIME:300,CACHE_TIMINGS:{tags:0},V2_PREFIX:"[v2]:"}},{}],2:[function(t,e,r){"use strict";function n(){this.data={}}n.prototype={storePosition:function(t){if("number"!=typeof t.longitude&&isNaN(parseFloat(t.longitude))||"number"!=typeof t.latitude&&isNaN(parseFloat(t.latitude)))throw new Error("Glimr.storePosition requires one argument, an object with a numeric .longitude and .latitude");this._store("u_pos",[t.latitude,t.longitude].join(","))},_store:function(t,e){this.data[t]=e},_flush:function(){var t=this.data;return this.data={},t}},e.exports=n},{}],3:[function(t,e,r){"use strict";function n(t,e){l.prototype[t]=function(){return this[e][t].apply(this[e],arguments)}}var i=t("./lib/functools"),a=t("./constants"),o=t("./serialize"),s=t("./tags"),u=t("./glimr_id"),c=t("./tag_cache"),h=t("./storage"),g=t("./enrichment"),l=function(){this.constructor=l,this.initialize()};l.prototype={initialize:function(){this.url={host:a.GLIMR_HOST,tags:a.GLIMR_PATHS.tags,store:a.GLIMR_PATHS.store},this.glimrId=new u,this.storage=new h(i.bindFunction(this,function(){return this.useLocalStorage})),this.enrichment=new g,this.tagCache=new c(this.storage),this.tags=new s(this.storage,this.tagCache,this.glimrId,this.url,this.enrichment),this.useLocalStorage=h.isSupportedByBrowser()}};var d,f=["objectToQuery","arrayToQuery","queryToObject","escapeStringForQuery","unescapeStringForQuery"];for(d=0;d<f.length;d+=1){var p=f[d];l.prototype[p]=o[p]}var T=["getPixelLastUpdated","getCachedURLTags","getCachedBehaviorTags","getCachedBehaviorTagsAndUpdateInBackground","getTagsAndPushToDataLayer","getTags"];for(d=0;d<T.length;d+=1)n(T[d],"tags");var y=["usesTagCache","isTagCacheValid","setTagCacheTimeInSeconds","getTagCacheTimeInSeconds","currentURLIdentifier"];for(d=0;d<y.length;d+=1)n(y[d],"tagCache");var C=["storePosition"];for(d=0;d<C.length;d+=1)n(C[d],"enrichment");e.exports=new l},{"./constants":1,"./enrichment":2,"./glimr_id":4,"./lib/functools":6,"./serialize":12,"./storage":13,"./tag_cache":14,"./tags":15}],4:[function(t,e,r){"use strict";function n(){this.initialize()}var i=t("./lib/cookies"),a=t("./lib/uuid");n.prototype={initialize:function(){this._id=i.readCookie("__glmrid"),this._id||this.setId(a.generate())},setGlimrCookie:function(){i.createCookie("__glmrid",this._id)},getId:function(){return this._id},setId:function(t){this._id=t,this.setGlimrCookie()}},e.exports=n},{"./lib/cookies":5,"./lib/uuid":11}],5:[function(t,e,r){"use strict";var n={createCookie:function(t,e,r){var n=window.document.location.hostname.split("."),i=n.slice(n.length-2,n.length).join("."),a="";if(r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3),a="; expires="+o.toGMTString()}window.document.cookie=t+"="+e+a+"; path=/; domain="+i},readCookie:function(t){for(var e=t+"=",r=window.document.cookie.split(";"),n=0;n<r.length;n+=1){for(var i=r[n];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(e))return i.substring(e.length,i.length)}return null}};e.exports=n},{}],6:[function(t,e,r){"use strict";var n={bindFunction:function(t,e){var r=Array.prototype.slice.call(arguments,2),n=e,i=function(){},a=function(){return n.apply(this instanceof i?this:t,r.concat(Array.prototype.slice.call(arguments)))};return e.prototype&&(i.prototype=e.prototype),a.prototype=new i,a}};e.exports=n},{}],7:[function(t,e,r){"use strict";var n=function(t,e){var r=(new Date).getTime(),n="glmrjsonp"+Math.round(r+1000001*Math.random()),i=window.document.createElement("script");window[n]=function(t){e(t);try{delete window[n]}catch(t){window[n]=void 0}try{i.parentNode.removeChild(i)}catch(t){}},t+=t.indexOf("?")===-1?"?":"&",t+="callback="+n,"function"==typeof i.addEventListener&&i.addEventListener("error",function(){e(!1)},!1),i.setAttribute("src",t),window.document.getElementsByTagName("head")[0].appendChild(i)};e.exports=n},{}],8:[function(t,e,r){"use strict";var n=function(t){function e(t,e){return t<<e|t>>>32-e}function r(t,e){var r,n,i,a,o;return i=2147483648&t,a=2147483648&e,r=1073741824&t,n=1073741824&e,o=(1073741823&t)+(1073741823&e),r&n?2147483648^o^i^a:r|n?1073741824&o?3221225472^o^i^a:1073741824^o^i^a:o^i^a}function n(t,e,r){return t&e|~t&r}function i(t,e,r){return t&r|e&~r}function a(t,e,r){return t^e^r}function o(t,e,r){return e^(t|~r)}function s(t,i,a,o,s,u,c){return t=r(t,r(r(n(i,a,o),s),c)),r(e(t,u),i)}function u(t,n,a,o,s,u,c){return t=r(t,r(r(i(n,a,o),s),c)),r(e(t,u),n)}function c(t,n,i,o,s,u,c){return t=r(t,r(r(a(n,i,o),s),c)),r(e(t,u),n)}function h(t,n,i,a,s,u,c){return t=r(t,r(r(o(n,i,a),s),c)),r(e(t,u),n)}function g(t){for(var e,r=t.length,n=r+8,i=(n-n%64)/64,a=16*(i+1),o=Array(a-1),s=0,u=0;u<r;)e=(u-u%4)/4,s=u%4*8,o[e]=o[e]|t.charCodeAt(u)<<s,u+=1;return e=(u-u%4)/4,s=u%4*8,o[e]=o[e]|128<<s,o[a-2]=r<<3,o[a-1]=r>>>29,o}function l(t){var e,r,n="",i="";for(r=0;r<=3;r+=1)e=t>>>8*r&255,i="0"+e.toString(16),n+=i.substr(i.length-2,2);return n}function d(t){t=t.replace(/\r\n/g,"\n");for(var e="",r=0;r<t.length;r+=1){var n=t.charCodeAt(r);n<128?e+=String.fromCharCode(n):n>127&&n<2048?(e+=String.fromCharCode(n>>6|192),e+=String.fromCharCode(63&n|128)):(e+=String.fromCharCode(n>>12|224),e+=String.fromCharCode(n>>6&63|128),e+=String.fromCharCode(63&n|128))}return e}var f,p,T,y,C,m,v,_,w,b=[],x=7,I=12,S=17,L=22,A=5,U=9,E=14,j=20,R=4,O=11,F=16,M=23,P=6,Q=10,k=15,z=21;for(t=d(t),b=g(t),m=1732584193,v=4023233417,_=2562383102,w=271733878,f=0;f<b.length;f+=16)p=m,T=v,y=_,C=w,m=s(m,v,_,w,b[f+0],x,3614090360),w=s(w,m,v,_,b[f+1],I,3905402710),_=s(_,w,m,v,b[f+2],S,606105819),v=s(v,_,w,m,b[f+3],L,3250441966),m=s(m,v,_,w,b[f+4],x,4118548399),w=s(w,m,v,_,b[f+5],I,1200080426),_=s(_,w,m,v,b[f+6],S,2821735955),v=s(v,_,w,m,b[f+7],L,4249261313),m=s(m,v,_,w,b[f+8],x,1770035416),w=s(w,m,v,_,b[f+9],I,2336552879),_=s(_,w,m,v,b[f+10],S,4294925233),v=s(v,_,w,m,b[f+11],L,2304563134),m=s(m,v,_,w,b[f+12],x,1804603682),w=s(w,m,v,_,b[f+13],I,4254626195),_=s(_,w,m,v,b[f+14],S,2792965006),v=s(v,_,w,m,b[f+15],L,1236535329),m=u(m,v,_,w,b[f+1],A,4129170786),w=u(w,m,v,_,b[f+6],U,3225465664),_=u(_,w,m,v,b[f+11],E,643717713),v=u(v,_,w,m,b[f+0],j,3921069994),m=u(m,v,_,w,b[f+5],A,3593408605),w=u(w,m,v,_,b[f+10],U,38016083),_=u(_,w,m,v,b[f+15],E,3634488961),v=u(v,_,w,m,b[f+4],j,3889429448),m=u(m,v,_,w,b[f+9],A,568446438),w=u(w,m,v,_,b[f+14],U,3275163606),_=u(_,w,m,v,b[f+3],E,4107603335),v=u(v,_,w,m,b[f+8],j,1163531501),m=u(m,v,_,w,b[f+13],A,2850285829),w=u(w,m,v,_,b[f+2],U,4243563512),_=u(_,w,m,v,b[f+7],E,1735328473),v=u(v,_,w,m,b[f+12],j,2368359562),m=c(m,v,_,w,b[f+5],R,4294588738),w=c(w,m,v,_,b[f+8],O,2272392833),_=c(_,w,m,v,b[f+11],F,1839030562),v=c(v,_,w,m,b[f+14],M,4259657740),m=c(m,v,_,w,b[f+1],R,2763975236),w=c(w,m,v,_,b[f+4],O,1272893353),_=c(_,w,m,v,b[f+7],F,4139469664),v=c(v,_,w,m,b[f+10],M,3200236656),m=c(m,v,_,w,b[f+13],R,681279174),w=c(w,m,v,_,b[f+0],O,3936430074),_=c(_,w,m,v,b[f+3],F,3572445317),v=c(v,_,w,m,b[f+6],M,76029189),m=c(m,v,_,w,b[f+9],R,3654602809),w=c(w,m,v,_,b[f+12],O,3873151461),_=c(_,w,m,v,b[f+15],F,530742520),v=c(v,_,w,m,b[f+2],M,3299628645),m=h(m,v,_,w,b[f+0],P,4096336452),w=h(w,m,v,_,b[f+7],Q,1126891415),_=h(_,w,m,v,b[f+14],k,2878612391),v=h(v,_,w,m,b[f+5],z,4237533241),m=h(m,v,_,w,b[f+12],P,1700485571),w=h(w,m,v,_,b[f+3],Q,2399980690),_=h(_,w,m,v,b[f+10],k,4293915773),v=h(v,_,w,m,b[f+1],z,2240044497),m=h(m,v,_,w,b[f+8],P,1873313359),w=h(w,m,v,_,b[f+15],Q,4264355552),_=h(_,w,m,v,b[f+6],k,2734768916),v=h(v,_,w,m,b[f+13],z,1309151649),m=h(m,v,_,w,b[f+4],P,4149444226),w=h(w,m,v,_,b[f+11],Q,3174756917),_=h(_,w,m,v,b[f+2],k,718787259),v=h(v,_,w,m,b[f+9],z,3951481745),m=r(m,p),v=r(v,T),_=r(_,y),w=r(w,C);var G=l(m)+l(v)+l(_)+l(w);return G.toLowerCase()};e.exports=n},{}],9:[function(t,e,r){"use strict";var n={flattenObjectIntoArray:function(t){var e=[];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){var i=t[r];if("object"==typeof i&&i.constructor===Array)for(var a=0,o=i.length;a<o;a+=1)e.push(i[a]);else"object"==typeof i?e=e.concat(n.flattenObjectIntoArray(i)):e.push(i)}return e}};e.exports=n},{}],10:[function(t,e,r){"use strict";var n=function(){var t,e,r=(new Date).getTime().toString();try{return(t=window.localStorage).setItem(r,r),e=t.getItem(r)===r,t.removeItem(r),e&&t}catch(t){}}();e.exports=n},{}],11:[function(t,e,r){"use strict";var n={generate:function(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?r:3&r|8).toString(16)})}};e.exports=n},{}],12:[function(t,e,r){"use strict";var n={objectToQuery:function(t,e){e=e||"";var r=[];for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i)){var a,o=t[i];if(a=e.length?e+"["+n.escapeStringForQuery(i)+"]":n.escapeStringForQuery(i),"object"==typeof o&&o.constructor===Array){for(var s=0,u=o.length;s<u;s+=1)r.push(a+"="+n.escapeStringForQuery(o[s])),r.push("&");r.pop()}else"object"==typeof o?r.push(n.objectToQuery(o,a)):r.push(a+"="+n.escapeStringForQuery(o));r.push("&")}return r.pop(),r.join("")},arrayToQuery:function(t,e){e=e||"";for(var r=n.escapeStringForQuery(e),i=[],a=0,o=t.length;a<o;a+=1){var s=n.escapeStringForQuery(t[a]);i.push(r+"="+s)}return i.join("&")},queryToObject:function(t){for(var e={},r=t.split("&"),i=0,a=r.length;i<a;i+=1){var o=r[i].split("="),s=n.unescapeStringForQuery(o[0]||""),u=n.unescapeStringForQuery(o[1]||"");"undefined"==typeof e[s]&&(e[s]=[]),u.length>0&&e[s].push(u)}return e},escapeStringForQuery:function(t){return encodeURIComponent(t)},unescapeStringForQuery:function(t){return decodeURIComponent(t)}};e.exports=n},{}],13:[function(t,e,r){"use strict";function n(t){this._isEnabledCallback=t}var i=t("./lib/storage");n.prototype={set:function(t,e){i[t]=e},get:function(t){return i[t]},isEnabled:function(){return this._isEnabledCallback()}},n.isSupportedByBrowser=function(){return!!i},e.exports=n},{"./lib/storage":10}],14:[function(t,e,r){"use strict";function n(t,e){return new TypeError("Parameter #"+t+" is required: "+e)}function i(t){this.storage=t,this.state={urlCache:{},currentURLCacheKey:!1}}var a=t("./lib/md5"),o=t("./constants"),s=t("./serialize");i.prototype={usesTagCache:function(){return o.CACHE_TIMINGS.tags>0&&this.storage.isEnabled()},isTagCacheValid:function(t){if("undefined"==typeof t)throw n(0,"pixelId");var e=parseInt(this.storage.get("glimrTags_"+t+"_lastUpdate"),10),r=(new Date).getTime();return!isNaN(e)&&(r-e)/1e3<o.CACHE_TIMINGS.tags},setTagCacheTimeInSeconds:function(t){t>o.MAX_CACHE_TIME&&(t=o.MAX_CACHE_TIME),o.CACHE_TIMINGS.tags=t},getTagCacheTimeInSeconds:function(){return o.CACHE_TIMINGS.tags},currentURLIdentifier:function(){return window.document.location.hash&&window.document.location.hash.indexOf("#!")!==-1?window.document.location.hash.replace("#!",""):window.document.location.pathname},_currentURLCacheKey:function(){return this.state.currentURLCacheKey?this.state.currentURLCacheKey:a(this.currentURLIdentifier()).substr(0,10)},_unmarshalTags:function(t){if(!t)return{};for(var e=t.split("|"),r={},n=0;n<e.length;n+=1){var i=e[n].indexOf("="),a=e[n].substring(0,i);r[a]=this._deserializeTags(e[n].substring(i+1))}return r},_marshalTags:function(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&e.push(r.substr(0,10)+"="+this._serializeTags(t[r]));return e.join("|")},_getOrUnmarshalCache:function(t){return this.storage.isEnabled()&&this.storage.get("glimrArticleTags_"+t)&&(this.state.urlCache[t]=this._unmarshalTags(this.storage.get("glimrArticleTags_"+t))),this.state.urlCache[t]||{}},_serializeTags:function(t){return"object"==typeof t&&t.constructor===Array?t.join(","):o.V2_PREFIX+s.objectToQuery(t)},_deserializeTags:function(t){return t=t||"",t.substr(0,o.V2_PREFIX.length)===o.V2_PREFIX?s.queryToObject(t.substr(o.V2_PREFIX.length)):""===t?[]:t.split(",")},_updateTagCache:function(t,e){this.storage.isEnabled()&&(this.storage.set("glimrTags_"+t+"_lastUpdate",(new Date).getTime()),this.storage.set("glimrTags_"+t,this._serializeTags(e)))},_updateURLCache:function(t,e){this.storage.isEnabled()&&(this.storage.set("glimrArticleTags_"+t,this._marshalTags(e)),this.storage.set("glimrArticleTags_"+t+"_lastUpdate",(new Date).getTime())),this.state.urlCache[t]||(this.state.urlCache[t]={});for(var r in e)e.hasOwnProperty(r)&&(this.state.urlCache[t][r.substr(0,10)]=e[r])}},e.exports=i},{"./constants":1,"./lib/md5":8,"./serialize":12}],15:[function(t,e,r){"use strict";function n(t,e){return new TypeError("Parameter #"+t+" is required: "+e)}function i(t,e,r,n,i){this.storage=t,this.tagCache=e,this.state={loadingTags:{},loadedTags:{},currentURLCacheKey:!1},this.networkRequests=0,this.glimrId=r,this.url=n,this.enrichment=i}var a=t("./lib/functools"),o=t("./lib/objecttools"),s=(t("./lib/md5"),t("./lib/jsonp")),u=t("./serialize");t("./constants");i.prototype={getPixelLastUpdated:function(t){return!!this.storage.isEnabled()&&(this.storage.get("glimrArticleTags_"+t+"_lastUpdate")||!1)},getCachedURLTags:function(t){if("undefined"==typeof t)throw n(0,"pixelId");var e=this.tagCache._getOrUnmarshalCache(t),r=this.tagCache._currentURLCacheKey();return e[r]||(e[r]=[]),e[r]},getCachedBehaviorTags:function(t){if("undefined"==typeof t)throw n(0,"pixelId");if(this.tagCache.usesTagCache()&&this.tagCache.isTagCacheValid(t)){var e=this._getLocalTags(t);return e[0]}return!1},getCachedBehaviorTagsAndUpdateInBackground:function(t,e){if("undefined"==typeof t)throw n(0,"pixelId");if(e=e||{},e.onUpdate="function"==typeof e.onUpdate?e.onUpdate:function(){},!this.tagCache.usesTagCache())return window.console&&window.console.error("Caching not enabled. Enable with Glimr.setTagCacheTimeInSeconds(number)"),[];var r=this._getLocalTags(t);return this.tagCache.isTagCacheValid(t)||this.getTags(t,e.onUpdate),r[0]||!1},getTagsAndPushToDataLayer:function(t,e){if("undefined"==typeof t)throw n(0,"pixelId");this.getTags(t,function(t){window.dataLayer&&window.dataLayer.push&&window.dataLayer.push({glimrTags:t,event:"glimr.tags"}),e&&"function"==typeof e&&e()})},getTags:function(t,e){if("undefined"==typeof t)throw n(0,"pixelId");var r=t+this.tagCache._currentURLCacheKey();if(this.state.loadedTags[r]){var i=this.state.loadedTags[r];return void e(i[0],i[1])}return"undefined"!=typeof this.state.loadingTags[r]?void this.state.loadingTags[r].push(e):void this._requestTags(t,r,e,a.bindFunction(this,function(e){var n=[],i={},a=n;e&&e.tags&&(n=e.tags,a=n),e&&e.mapping&&(i=e.mapping,a=i),e&&e.cache&&this.tagCache._updateURLCache(t,e.cache),this.tagCache.usesTagCache()&&this.tagCache._updateTagCache(t,a);for(var o=this.getCachedURLTags(t),s=0;s<o.length;s+=1)n.indexOf(o[s])===-1&&(n.push(o[s]),i.urlTags=i.urlTags||[],i.urlTags.push(o[s]));this.state.loadedTags[r]=[n,i];var u=this.state.loadingTags[r];delete this.state.loadingTags[r];for(var c=0;c<u.length;c+=1)u[c](n,i);"string"==typeof e.id&&e.id!==this.glimrId.getId()&&this.glimrId.setId(e.id)}))},_getLocalTags:function(t){var e=this.tagCache._deserializeTags(this.storage.get("glimrTags_"+t)),r=this.getCachedURLTags(t);if("object"==typeof e&&e.constructor===Array)return[e.concat(r),{urlTags:r}];e.urlTags=r;var n=o.flattenObjectIntoArray(e);return[n,e]},_requestTags:function(t,e,r,n){var i=this.getPixelLastUpdated(t),a="";i&&(a+="&keywords_last_updated="+i),window.document.location.hash&&(a+="&fragment="+encodeURIComponent(window.document.location.hash)),a+="&"+u.objectToQuery(this.enrichment._flush());var o=(this.url.host+this.url.tags).replace(":id",t)+"?id="+this.glimrId.getId()+a;if(this.tagCache.usesTagCache()&&this.tagCache.isTagCacheValid(t)){var c=this._getLocalTags(t);return void r(c[0],c[1])}this.state.loadingTags[e]=[],this.state.loadingTags[e].push(r),this.networkRequests+=1,s(o,n)}},e.exports=i},{"./constants":1,"./lib/functools":6,"./lib/jsonp":7,"./lib/md5":8,"./lib/objecttools":9,"./serialize":12}]},{},[3])(3)});
